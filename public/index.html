<!DOCTYPE html>
<html lang="en" x-data="main" x-init="init()">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="Ranziro Store" />
  <meta property="og:description" content="Jual beli akun Mobile Legends. Cek koleksi dan harga terbaik." />
  <meta property="og:image"
    content="https://lzycriwqrcqbiijtiipa.supabase.co/storage/v1/object/public/gambar/logo/meta_ranziro.webp" />
  <meta property="og:url" content="https://ranziro-server-production.up.railway.app" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:image"
    content="https://lzycriwqrcqbiijtiipa.supabase.co/storage/v1/object/public/gambar/logo/meta_ranziro.webp" />
  <link rel="image_src"
    href="https://lzycriwqrcqbiijtiipa.supabase.co/storage/v1/object/public/gambar/logo/meta_ranziro.webp" />

  <link rel="icon"
    href="https://lzycriwqrcqbiijtiipa.supabase.co/storage/v1/object/public/gambar/logo/meta_ranziro.webp"
    type="image/webp" width="32" height="32">
  <title>Ranziro Store</title>

  <script>
    (function () {
      if ('ontouchstart' in window || navigator.maxTouchPoints > 0) {
        document.documentElement.classList.add('is-touch');
      }
    })();
  </script>

  <!-- link css -->
  <link rel="stylesheet" href="css/style.css" />
  <link rel="stylesheet" href="assets/loader.css">
  <link rel="stylesheet" href="assets/cardAnim.css">

  <!-- Link Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Audiowide&family=Chau+Philomene+One:ital@0;1&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Rowdies:wght@300;400;700&display=swap"
    rel="stylesheet" />

  <!-- Font Awesome -->
  <script src="https://kit.fontawesome.com/b0ce53bf51.js" crossorigin="anonymous"></script>

  <!-- Alpine JS -->
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>

<body>
  <!-- sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <img loading="lazy"
        src="https://lzycriwqrcqbiijtiipa.supabase.co/storage/v1/object/public/gambar/logo/ranziro_store.webp"
        alt="ranziro_store" class="logo" />
      <button class="btn-close" id="btnClose"><i class="fa-solid fa-xmark"></i></button>
    </div>

    <a href="/mobile-legends" class="sidebar-links">
      <p>Mobile Legends</p>
      <i class="fa-solid fa-gamepad"></i>
    </a>

    <a target="_blank" rel="noopener noreferrer"
      href="https://wa.me/6285863146541?text=Halo%20Admin%20Ranziro%20Store.%20Saya%20ingin%20menjual%20akun%20saya."
      class="sidebar-links">
      <p>Jual Akun ?</p>
      <i class="fa-solid fa-tags"></i>
    </a>

    <!-- COMMUNITY BUTTON (di bawah Jual Akun) - tanpa caret -->
    <button class="sidebar-links" id="communityBtn" aria-expanded="false" aria-controls="communityMenu">
      <p style="margin:0; display:flex; align-items:center; gap:.6rem;">
        <span>Komunitas</span>
      </p>
      <i class="fa-solid fa-users"></i>
    </button>

    <!-- COMMUNITY MENU (item tanpa deskripsi kecil) -->
    <div class="community-menu" id="communityMenu" aria-hidden="true">
      <a class="sidebar-links" target="_blank" rel="noopener noreferrer"
        href="https://chat.whatsapp.com/CSiv9DhG6TUCKJWSkWLQIW">
        <p>Group WhatsApp</p>
        <i class="fa-brands fa-whatsapp"></i>
      </a>

      <a class="sidebar-links" target="_blank" rel="noopener noreferrer"
        href="https://whatsapp.com/channel/0029Vb6byeUDJ6H8aXr2SU3X">
        <p>Testimoni</p>
        <i class="fa-brands fa-whatsapp"></i>
      </a>

    </div>

    <div class="spacer"></div>
  </div>

  <!-- Container Search (letakkan di tempat semula) -->
  <div class="container-search" :class="{ 'open': searchOpen }" @click.outside="searchOpen = false"
    @keydown.escape.window="searchOpen = false" aria-hidden="false">

    <!-- compact filter row di bawah input (kecil) -->
    <div class="container-search-controls" style="display:flex; justify-content:space-between; gap:0.5rem; ">
      <div class="search-filter-group" role="tablist" aria-label="Filter status">
        <button class="search-filter-btn" :class="{ 'active': selectedFilterSearch === 'all' }"
          @click="setFilterSearch('all')">Semua</button>
        <button class="search-filter-btn" :class="{ 'active': selectedFilterSearch === 'available' }"
          @click="setFilterSearch('available')">Tersedia</button>
        <button class="search-filter-btn" :class="{ 'active': selectedFilterSearch === 'sold' }"
          @click="setFilterSearch('sold')">Terjual</button>
      </div>

      <div style="position:relative;">
        <button class="search-sort-btn" @click="sortOpenSmall = !sortOpenSmall"
          :aria-expanded="sortOpenSmall.toString()">
          <span x-text="selectedSortLabelSmall"></span>
          <svg width="12" height="12" viewBox="0 0 24 24" style="margin-left:6px; vertical-align:middle;" fill="none"
            aria-hidden="true">
            <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"
              stroke-linejoin="round" />
          </svg>
        </button>

        <div class="search-sort-menu" x-show="sortOpenSmall" x-cloak @click.outside="sortOpenSmall = false"
          x-transition:enter="transition ease-out duration-150" x-transition:enter-start="opacity-0 transform scale-95"
          x-transition:enter-end="opacity-100 transform scale-100" x-transition:leave="transition ease-in duration-100"
          x-transition:leave-start="opacity-100 transform scale-100"
          x-transition:leave-end="opacity-0 transform scale-95" style="right:0;">
          <button class="sort-item-sm" :class="{ 'active': selectedSortSearch === 'terbaru' }"
            @click="setSortSearch('terbaru'); sortOpenSmall=false">Terbaru</button>
          <button class="sort-item-sm" :class="{ 'active': selectedSortSearch === 'terlama' }"
            @click="setSortSearch('terlama'); sortOpenSmall=false">Terlama</button>
          <button class="sort-item-sm" :class="{ 'active': selectedSortSearch === 'a-z' }"
            @click="setSortSearch('a-z'); sortOpenSmall=false">A - Z</button>
        </div>
      </div>
    </div>

    <!-- Hasil Pencarian -->
    <div class="container-search-1" x-show="searchOpen" x-cloak>

      <!-- existing typing loader (biarkan) -->
      <div style="display:flex; align-items:center; gap:.6rem; padding:.5rem 0;">
        <div x-show="typing" x-cloak class="typing-loader" aria-hidden="true">
          <span></span>
          <span></span>
          <span></span>
        </div>
        <div style="color:#ccc; font-size:0.85rem;" x-text="typing ? 'Mencari...' : ''"></div>
      </div>

      <!-- jika tidak typing dan query ada tapi hasil = 0 -->
      <template x-if="!typing && tempSearchQuery.trim().length > 0 && filteredDataForSearch.length === 0 && loaded">
        <div style="width: 100%; display: flex; flex-direction: column; align-items: center;">
          <div style="padding:1rem; color:#ffffff52; text-align:center;">Akun tidak ditemukan</div>
          <i class="fa-solid fa-dice" style="font-size: 3rem; color: #ffffff52; top: -1rem; margin-bottom: 0.5rem;"></i>
        </div>
      </template>

      <!-- Jika search terbuka dan query kosong tapi hasil filter (available/sold/all) = 0 -->
      <template
        x-if="!typing && tempSearchQuery.trim().length === 0 && filteredDataForSearchAll.length === 0 && loaded">
        <div
          style="width:100%; display:flex; flex-direction:column; align-items:center; padding:1rem; color:#ffffff80; font-size: 0.9rem;">
          <template x-if="selectedFilterSearch === 'available'">
            <div>Tidak ada akun yang tersedia</div>
          </template>
          <template x-if="selectedFilterSearch === 'sold'">
            <div>Tidak ada akun yang terjual</div>
          </template>
          <template x-if="selectedFilterSearch === 'all'">
            <div>Akun tidak ditemukan</div>
          </template>
        </div>
      </template>

      <!-- Looping Data (filteredDataForSearch digunakan supaya special-case searchOpen & empty query) -->
      <template x-if="!typing">
        <template x-for="(game, idx) in filteredDataForSearch" :key="game.namaAkun + '|' + animCounterSearch">
          <a :href="`/akun?nama=${encodeURIComponent(game.namaAkun)}&harga=${encodeURIComponent(game.hargaAkun)}&status=${game.status}&ref=search_bar&src=ranziro&trackid=${Math.random().toString(36).substring(2,15)}`"
            class="search-links stagger-fade" :style="`animation-delay: ${getSearchDelay(idx)}s`">
            <div class="search-thumb">
              <div class="card-sold-search" x-show="!game.status" x-cloak aria-hidden="true">
                <span class="sold-search">SOLD</span>
              </div>
              <img loading="lazy" :src="game.imgAkun" alt="" class="img-search" :class="{'img-sold': !game.status}" />
            </div>
            <div class="container-search-2">
              <h3 x-text="game.namaAkun" class="search-akun"></h3>
              <p x-text="game.hargaAkun"></p>
            </div>
          </a>
        </template>
      </template>

      <!-- tombol tampilkan lebih banyak -->
      <div style="text-align:center; padding:.5rem;"
        x-show="filteredDataForSearchAll.length > filteredDataForSearch.length">
        <button class="search-filter-btn" @click="loadMoreSearch()" type="button">Tampilkan lebih banyak</button>
      </div>

      <!-- sentinel untuk infinite scroll (opsional) -->
      <div x-ref="searchSentinel"></div>
      <!-- Loader ketika buka search -->
    </div>
  </div>

  <!-- header -->
  <header>
    <div>
      <button class="btn-menu">
        <i class="fa-solid fa-bars"></i>
      </button>

      <img loading="lazy"
        src="https://lzycriwqrcqbiijtiipa.supabase.co/storage/v1/object/public/gambar/logo/ranziro_store.webp"
        alt="ranziro_store" class="logo" />
    </div>

    <button class="btn-search">
      <i class="fa-solid fa-magnifying-glass"></i>

      <!-- Input Search -->
      <input type="text" id="input-search" class="input-search" placeholder="Cari akun..." x-model="tempSearchQuery"
        @focus="onSearchFocus()" @input="onTyping()" autocomplete="new-password" />

    </button>

  </header>

  <!-- main -->
  <main>
    <section class="container-banner">
      <!-- Canvas existing (tetap) -->
      <canvas id="star-canvas" aria-hidden="true"></canvas>

      <div class="banner-slider" id="bannerSlider" aria-roledescription="carousel">
        <div class="slides">
          <!-- Slide 1 -->
          <div class="slide" role="group" aria-roledescription="slide" aria-label="1 of 3">
            <img loading="lazy"
              src="https://lzycriwqrcqbiijtiipa.supabase.co/storage/v1/object/public/gambar/banner/Banner_1.webp"
              alt="Banner 1">
          </div>

          <!-- Slide 2 (ganti url dengan gambar yang diinginkan) -->
          <div class="slide" role="group" aria-roledescription="slide" aria-label="2 of 3">
            <img loading="lazy"
              src="https://lzycriwqrcqbiijtiipa.supabase.co/storage/v1/object/public/gambar/banner/Banner_2.webp"
              alt="Banner 2">
          </div>

        </div>

        <!-- Controls -->
        <button class="banner-prev" aria-label="Previous slide">&#10094;</button>
        <button class="banner-next" aria-label="Next slide">&#10095;</button>

        <!-- Dots -->
        <div class="banner-dots" aria-hidden="false"></div>
      </div>
    </section>

    <section class="container-list">
      <div class="container-list-1">
        <div class="list-title">Temukan Akun Favoritmu <img loading="lazy"
            src="https://lzycriwqrcqbiijtiipa.supabase.co/storage/v1/object/public/gambar/gif/fire.gif"
            alt="GIF Animasi">
        </div>

        <div
          style="width: 100%; display: flex; justify-content: space-between; align-items: center; gap:1rem; flex-wrap:wrap;">
          <div class="container-filter" role="tablist" aria-label="Filter akun">
            <button class="filter-btn" :class="{ 'active': selectedFilter === 'all' }" @click="setFilter('all')"
              type="button">Semua</button>

            <button class="filter-btn" :class="{ 'active': selectedFilter === 'available' }"
              @click="setFilter('available')" type="button">Tersedia</button>

            <button class="filter-btn" :class="{ 'active': selectedFilter === 'sold' }" @click="setFilter('sold')"
              type="button">Terjual</button>
          </div>

          <!-- DROPDOWN SORT -->
          <div style="position:relative;" aria-haspopup="true" aria-owns="sort-menu">
            <button class="filter-btn" @click="sortOpen = !sortOpen" :aria-expanded="sortOpen.toString()" type="button">
              Sort: <span style="margin-left:.5rem; font-weight:600;" x-text="selectedSortLabel"></span>
              <svg style="margin-left:.6rem;" width="12" height="12" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"
                  stroke-linejoin="round" />
              </svg>
            </button>

            <!-- menu -->
            <div id="sort-menu" x-show="sortOpen" x-transition:enter="transition ease-out duration-150"
              x-transition:enter-start="opacity-0 transform scale-95"
              x-transition:enter-end="opacity-100 transform scale-100"
              x-transition:leave="transition ease-in duration-100"
              x-transition:leave-start="opacity-100 transform scale-100"
              x-transition:leave-end="opacity-0 transform scale-95" @click.outside="sortOpen = false"
              @keydown.escape.window="sortOpen = false" class="sort-menu" x-cloak role="menu" aria-label="Sort options">
              <button role="menuitem" tabindex="0" class="sort-item" :class="{ 'active': selectedSort === 'terbaru' }"
                @click="setSort('terbaru'); sortOpen=false">Terbaru</button>
              <button role="menuitem" tabindex="0" class="sort-item" :class="{ 'active': selectedSort === 'terlama' }"
                @click="setSort('terlama'); sortOpen=false">Terlama</button>
              <button role="menuitem" tabindex="0" class="sort-item" :class="{ 'active': selectedSort === 'a-z' }"
                @click="setSort('a-z'); sortOpen=false">A - Z</button>
            </div>
          </div>
        </div>
      </div>

      <div class="container-list-3">
        <!-- Modified: staggered fade + index + key with animCounterMain -->
        <template x-for="(game, idx) in visibleData" :key="game.namaAkun + '|' + animCounterMain">
          <a :href="`/akun?nama=${encodeURIComponent(game.namaAkun)}&harga=${encodeURIComponent(game.hargaAkun)}&status=${game.status}&ref=main_list&src=ranziro&trackid=${Math.random().toString(36).substring(2,15)}`"
            class="card-parents stagger-fade" :style="`animation-delay: ${getMainDelay(idx)}s`"
            x-transition:enter="fade-up-enter" x-transition:enter-start="fade-up-enter-start"
            x-transition:enter-end="fade-up-enter-end" x-transition:leave="fade-up-leave"
            x-transition:leave-start="fade-up-leave-start" x-transition:leave-end="fade-up-leave-end" x-cloak
            aria-hidden="false">
            <div class="card">
              <div class="card-sold" x-show="!game.status" x-cloak aria-hidden="true">
                <div class="sold">SOLD</div>
              </div>

              <div class="card-loader" x-show="game.status" x-cloak aria-hidden="true">
                <div class="loader"></div>
              </div>

              <img loading="lazy" :src="game.imgAkun" :alt="game.namaAkun" :class="{'img-sold': !game.status}" />
            </div>

            <div class="card-info-2">
              <div class="card-h3" x-text="game.namaAkun"></div>
              <p class="card-p" x-text="game.hargaAkun"></p>
            </div>
          </a>
        </template>

      </div>
      <!-- pesan jika kosong (tampilkan hanya setelah data ter-load) -->
      <template x-if="filteredLength === 0 && loaded">
        <div class="empty-message"
          style=" padding: 1rem; color:#ffffff80; width: 100%; text-align: center; font-size: 0.9rem;">
          <template x-if="selectedFilter === 'available'">
            <div>Tidak ada akun yang tersedia</div>
          </template>
          <template x-if="selectedFilter === 'sold'">
            <div>Tidak ada akun yang terjual</div>
          </template>
          <template x-if="selectedFilter === 'all'">
            <div>Akun tidak ditemukan</div>
          </template>
        </div>
      </template>

      <div class="container-load-more">
        <button class="filter-btn" x-show="filteredLength > visibleCountMain" @click="loadMoreMain()" x-cloak
          type="button">Tampilkan lebih banyak
        </button>
      </div>

      <div class="container-unggul-parent">
        <h2>Keunggulan</h2>
        <div class="container-unggul">
          <div class="container-unggul-child">
            <div>
              <h3>Proses Cepat & Mudah</h2>
                <p>Proses pembayaran cepat dan mudah</p>
            </div>
            <i class="fa-solid fa-bolt"></i>
          </div>

          <div class="container-unggul-child">
            <div>
              <h3>Pembayaran Terpercaya</h2>
                <p>Pembayaran terpercaya dan aman</p>
            </div>
            <i class="fa-solid fa-wallet"></i>
          </div>

          <div class="container-unggul-child">
            <div>
              <h3>Jaminan Layanan</h2>
                <p>Jaminan layanan 24 jam non-stop</p>
            </div>
            <i class="fa-solid fa-phone"></i>
          </div>

          <div class="container-unggul-child">
            <div>
              <h3>Pilihan rekber & direct</h2>
                <p>Bisa memilih ingin rekber atau direct</p>
            </div>
            <i class="fa-solid fa-comments"></i>
          </div>
        </div>
      </div>
    </section>

    <!-- footer -->
    <footer>
      <!-- wave -->
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320">
        <path fill="#242424" fill-opacity="1"
          d="M0,192L18.5,165.3C36.9,139,74,85,111,80C147.7,75,185,117,222,160C258.5,203,295,245,332,266.7C369.2,288,406,288,443,266.7C480,245,517,203,554,208C590.8,213,628,267,665,250.7C701.5,235,738,149,775,117.3C812.3,85,849,107,886,144C923.1,181,960,235,997,256C1033.8,277,1071,267,1108,218.7C1144.6,171,1182,85,1218,42.7C1255.4,0,1292,0,1329,10.7C1366.2,21,1403,43,1422,53.3L1440,64L1440,320L1421.5,320C1403.1,320,1366,320,1329,320C1292.3,320,1255,320,1218,320C1181.5,320,1145,320,1108,320C1070.8,320,1034,320,997,320C960,320,923,320,886,320,849.2,320,812,320,775,320,738.5,320,702,320,665,320,627.7,320,591,320,554,320,516.9,320,480,320,443,320,406.2,320,369,320,332,320,295.4,320,258,320,222,320,184.6,320,148,320,111,320,73.8,320,37,320,18,320L0,320Z">
        </path>
      </svg>
      <div class="footer-2">
        <div class="footer-card">
          <img loading="lazy"
            src="https://lzycriwqrcqbiijtiipa.supabase.co/storage/v1/object/public/gambar/logo/ranziro_store.webp"
            alt="ranziro_store" class="footer-logo" />
          <div class="footer-deskripsi">
            Ranziro Store menjual berbagai akun Mobile Legends dengan harga bervariasi sesuai budgetmu. Pilihan terbaik
            untuk para
            gamers sejati!
          </div>
        </div>

        <div class="footer-card">
          <div class="footer-title">Peta Situs</div>
          <div class="footer-hr"></div>
          <div class="footer-list">
            <a href="/mobile-legends" class="footer-links">Mobile Legends</a>
          </div>
        </div>

        <div class="footer-card">
          <div class="footer-title">Media Sosial</div>
          <div class="footer-hr"></div>
          <div class="footer-list" style="display: flex; flex-direction: row; gap: 0.5rem;">
            <a style="width: 30px; height: 30px; font-size:1rem; padding:5px; display: grid; place-items: center; border-radius:50%; transition: background-color .3s ease;"
              href="https://www.instagram.com/ranzirostore.backup/" class="footer-links" target="_blank"
              rel="noopener noreferrer" onmouseenter="this.style.background='#db2777'; this.style.color='white';"
              onmouseleave="this.style.background='transparent'; this.style.color='white';">
              <i class="fa-brands fa-instagram"></i>
            </a>

            <a style="width: 30px; height: 30px; font-size:1rem; padding:5px; display: grid; place-items: center; border-radius:50%; transition: background-color .3s ease;"
              href="https://www.youtube.com/@ranziroo11" class="footer-links" target="_blank" rel="noopener noreferrer"
              onmouseenter="this.style.background='red'; this.style.color='white';"
              onmouseleave="this.style.background='transparent'; this.style.color='white';">
              <i class="fa-brands fa-youtube"></i>
            </a>

          </div>
        </div>

        <div class="footer-card">
          <div class="footer-title">Kontak kami</div>
          <div class="footer-hr"></div>
          <div class="footer-list">
            <a href="https://wa.me/6285863146541" class="footer-links">WhatsApp</a>
            <a href="mailto:Ranziro Store@gmail.com" class="footer-links">Email</a>
          </div>
        </div>
        <hr style="width: 100%; height: 1px; background: #ffffff9d; border: none;">
      </div>

      <div class="coppyright">
        <div>&copy; <span id="year"></span> Ranziro Store</div>
        <div>Terakhir diakses: <span id="last-accessed"></span></div>
      </div>
    </footer>

    <!-- Falling leaves background -->
<canvas id="bg-leaves" aria-hidden="true"></canvas>

  </main>

  <!-- existing project scripts (tetap) -->
  <script src="js/apwssmeoow2453sGH.min.js"></script>
  <script src="js/glwoblswsmsw.min.js"></script>
  <script src="assets/lload34mdelp.min.js"></script>
  <script src="js/components/strsInd4swsl2023dk.min.js"></script>
  <script src="js/components/lstyr29331sw.min.js"></script>
  <script src="js/components/cmmntybTnr33302.min.js"></script>
  <script src="js/components/sldrIndxes234.min.js"></script>

<script>
(function(){
  const canvas = document.getElementById('bg-leaves');
  if(!canvas) return;
  const ctx = canvas.getContext('2d', { alpha: true });

  // CONFIG (sesuaikan bila perlu)
  const CONF = {
    baseCount: 28,
    sizeRange: [20, 48],
    speedY: [0.35, 1.1],
    swayRange: [26, 120],
    rotateSpeed: [0.004, 0.02],
    colors: [
      ['#f2a44b','#d67a2a'],
      ['#e58b3a','#b25a2a'],
      ['#d66f3a','#9d4a22'],
      ['#ffd07a','#e6a64a']
    ],
    dprCap: 2,
    fpsCap: 60
  };

  // --- state ---
  let DPR = Math.max(1, Math.min(window.devicePixelRatio || 1, CONF.dprCap));
  let W = 0, H = 0;
  let leaves = [];
  let leavesSorted = null;
  let then = performance.now();
  const frameInterval = 1000 / Math.min(CONF.fpsCap || 60, 60);
  let needsSort = false;
  const spriteCache = new Map(); // key: `${sizeBucket}_${colorIdx}_${dpr}` -> offscreen canvas

  // micro-optimizations
  const _sin = Math.sin;
  const _cos = Math.cos;
  const _floor = Math.floor;
  const _round = Math.round;

  // helpers
  const rand = (a,b) => a + Math.random()*(b-a);
  const pickIndex = arr => Math.floor(Math.random()*arr.length);
  const pick = arr => arr[pickIndex(arr)];

  function hexToRgb(hex){
    hex = (hex||'').replace('#','');
    const r = parseInt(hex.substring(0,2),16);
    const g = parseInt(hex.substring(2,4),16);
    const b = parseInt(hex.substring(4,6),16);
    return [r,g,b];
  }
  function rgbaStrFromHex(hex, a){
    const [r,g,b] = hexToRgb(hex);
    return `rgba(${r},${g},${b},${a})`;
  }
  function shadeHex(hex, amt){
    hex = (hex||'').replace('#','');
    let r = Math.max(0, Math.min(255, parseInt(hex.substring(0,2),16) + amt));
    let g = Math.max(0, Math.min(255, parseInt(hex.substring(2,4),16) + amt));
    let b = Math.max(0, Math.min(255, parseInt(hex.substring(4,6),16) + amt));
    return '#' + [r,g,b].map(v => v.toString(16).padStart(2,'0')).join('');
  }

  // leaf factory
  function makeLeaf(){
    const size = rand(CONF.sizeRange[0], CONF.sizeRange[1]);
    const colorIdx = pickIndex(CONF.colors);
    return {
      x: Math.random() * W,
      y: Math.random() * H - H * Math.random(),
      size,
      baseSize: size,
      sizeBucket: bucketSize(size),
      sway: rand(CONF.swayRange[0], CONF.swayRange[1]),
      phase: Math.random() * Math.PI * 2,
      angle: rand(-0.6, 0.6),
      rotate: rand(CONF.rotateSpeed[0], CONF.rotateSpeed[1]) * (Math.random() < 0.5 ? -1 : 1),
      colorIndex: colorIdx,
      colorPair: CONF.colors[colorIdx],
      speed: rand(CONF.speedY[0], CONF.speedY[1]),
      tilt: rand(-0.18, 0.18),
      detail: Math.random()
    };
  }

  // size bucket (reduce unique sprite count)
  function bucketSize(s){
    // bucket step 2px; clamp
    return Math.max(CONF.sizeRange[0], Math.min(CONF.sizeRange[1], Math.round(s/2)*2));
  }

  // resize/init
  function resize(){
    const oldDpr = DPR;
    DPR = Math.max(1, Math.min(window.devicePixelRatio || 1, CONF.dprCap));
    W = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);
    H = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);
    canvas.style.width = W + 'px';
    canvas.style.height = H + 'px';
    canvas.width = Math.round(W * DPR);
    canvas.height = Math.round(H * DPR);
    ctx.setTransform(DPR,0,0,DPR,0,0);

    // if DPR changed, clear sprite cache
    if (oldDpr !== DPR) spriteCache.clear();

    const areaFactor = Math.sqrt(W * H) / 1400;
    const target = Math.round(CONF.baseCount * Math.max(0.45, Math.min(areaFactor, 1.6)));
    leaves = leaves.slice(0, target);
    while(leaves.length < target) leaves.push(makeLeaf());

    // ensure sizeBucket set
    for(let i=0;i<leaves.length;i++){
      leaves[i].sizeBucket = bucketSize(leaves[i].baseSize);
    }

    // create sorted view
    leavesSorted = leaves.slice().sort((a,b)=> a.baseSize - b.baseSize);
    needsSort = false;
  }

  // Simple leaf path drawing onto a passed ctx centered at (cx,cy) pointing up.
  function simpleLeafPathLocal(ctxLocal, s){
    const w = s * 0.45;
    const h = s;
    ctxLocal.beginPath();
    ctxLocal.moveTo(0, 0.58 * h);
    ctxLocal.bezierCurveTo(w*0.6, 0.45*h, w*0.9, 0.05*h, w*0.35, -0.6*h);
    ctxLocal.quadraticCurveTo(w*0.06, -0.98*h, 0, -1.02*h);
    ctxLocal.quadraticCurveTo(-w*0.06, -0.98*h, -w*0.35, -0.6*h);
    ctxLocal.bezierCurveTo(-w*0.9, 0.05*h, -w*0.6, 0.45*h, 0, 0.58*h);
    ctxLocal.closePath();
  }

  // draw veins onto provided ctxLocal (same coordinate system as simpleLeafPathLocal)
  function drawVeinsLocal(ctxLocal, s, phase){
    ctxLocal.save();
    ctxLocal.lineCap = 'round';
    const veinColor = '#ffffff';
    ctxLocal.lineWidth = Math.max(0.9, s*0.035);
    ctxLocal.strokeStyle = rgbaStrFromHex(veinColor, 0.09);
    ctxLocal.beginPath();
    ctxLocal.moveTo(0, 0.56*s);
    ctxLocal.quadraticCurveTo(0.01*s, -0.02*s, 0, -1.02*s);
    ctxLocal.stroke();

    const branches = 5;
    for(let i=1;i<=branches;i++){
      const t = i / (branches + 1);
      const y = 0.56*s + (-1.58*s) * t;
      const len = s * (0.16 + 0.42 * (1 - t));
      const wob = _sin(phase + i) * 0.25;
      const ex = len * (0.5 + wob);
      const ey = y - s*0.03;

      ctxLocal.lineWidth = Math.max(0.45, s * 0.01);
      ctxLocal.strokeStyle = rgbaStrFromHex(veinColor, 0.06);
      ctxLocal.beginPath();
      ctxLocal.moveTo(0, y);
      ctxLocal.quadraticCurveTo(ex*0.35, ey, ex, ey - s*0.04);
      ctxLocal.stroke();

      ctxLocal.lineWidth = Math.max(0.3, s*0.007);
      ctxLocal.strokeStyle = rgbaStrFromHex(veinColor, 0.035);
      ctxLocal.beginPath();
      ctxLocal.moveTo(ex*0.5, ey - s*0.01);
      ctxLocal.quadraticCurveTo(ex*0.72, ey - s*0.03, ex*0.9, ey - s*0.05);
      ctxLocal.stroke();

      ctxLocal.lineWidth = Math.max(0.45, s * 0.01);
      ctxLocal.strokeStyle = rgbaStrFromHex(veinColor, 0.06);
      ctxLocal.beginPath();
      ctxLocal.moveTo(0, y);
      ctxLocal.quadraticCurveTo(-ex*0.35, ey, -ex, ey - s*0.04);
      ctxLocal.stroke();

      ctxLocal.lineWidth = Math.max(0.3, s*0.007);
      ctxLocal.strokeStyle = rgbaStrFromHex(veinColor, 0.035);
      ctxLocal.beginPath();
      ctxLocal.moveTo(-ex*0.5, ey - s*0.01);
      ctxLocal.quadraticCurveTo(-ex*0.72, ey - s*0.03, -ex*0.9, ey - s*0.05);
      ctxLocal.stroke();
    }
    ctxLocal.restore();
  }

  // create a cached sprite (offscreen canvas) for a bucket size and color index
  function createLeafSprite(size, colorIdx){
    const key = `${size}_${colorIdx}_${DPR}`;
    if(spriteCache.has(key)) return spriteCache.get(key);

    // sprite sizing: make sure canvas large enough to contain rotated leaf
    const s = size;
    const pad = Math.ceil(s * 0.28 + 6);
    const canvasSize = Math.ceil((s * 1.6) + pad*2);
    const off = document.createElement('canvas');
    off.width = canvasSize * DPR;
    off.height = canvasSize * DPR;
    off.style.width = `${canvasSize}px`;
    off.style.height = `${canvasSize}px`;
    const g = off.getContext('2d', { alpha: true });
    g.setTransform(DPR,0,0,DPR,0,0);

    const cx = canvasSize / 2;
    const cy = canvasSize / 2 + s*0.18; // offset so tip sits nicely
    g.translate(cx, cy);

    // gradient / fill
    const grad = g.createLinearGradient(0, s*0.9, 0, -s*1.02);
    const c1 = CONF.colors[colorIdx][0];
    const c2 = CONF.colors[colorIdx][1];
    grad.addColorStop(0, rgbaStrFromHex(c1, 0.96));
    grad.addColorStop(0.5, rgbaStrFromHex(shadeHex(c1, -8), 0.94));
    grad.addColorStop(0.9, rgbaStrFromHex(c2, 0.94));
    grad.addColorStop(1, rgbaStrFromHex(c2, 0.88));

    // shape + shadow
    g.save();
    simpleLeafPathLocal(g, s);
    g.fillStyle = grad;
    g.shadowColor = rgbaStrFromHex('#000000', 0.06);
    g.shadowBlur = Math.min(10, s * 0.14);
    g.fill();
    g.restore();

    // outline
    g.lineWidth = Math.max(0.6, s*0.013);
    g.strokeStyle = rgbaStrFromHex(shadeHex(c2, -6), 0.12);
    simpleLeafPathLocal(g, s);
    g.stroke();

    // veins
    drawVeinsLocal(g, s, 0); // phase not important for cached veins

    // speckles (tiny fixed texture)
    const speckles = Math.max(2, Math.round(s * 0.03));
    g.fillStyle = rgbaStrFromHex('#000000', 0.02);
    for(let i=0;i<speckles;i++){
      const rx = (_sin(i)*0.45) * s * 0.28;
      const ry = (i/speckles - 0.45) * s * 0.85;
      g.beginPath();
      g.arc(rx, ry, Math.max(0.3, s * 0.0055), 0, Math.PI*2);
      g.fill();
    }

    // reset transform
    g.setTransform(1,0,0,1,0,0);
    spriteCache.set(key, off);
    return off;
  }

  // draw one simple pointed leaf using cached sprite
  function drawLeafFromSprite(l, t){
    const x = l.x;
    const y = l.y;
    const s = l.size;
    const spriteSize = l.sizeBucket;
    const sprite = createLeafSprite(spriteSize, l.colorIndex);
    const imgW = sprite.width / DPR;
    const imgH = sprite.height / DPR;

    ctx.save();
    ctx.translate(x, y);

    const flutter = _sin(t*0.001 + l.phase) * 0.26;
    ctx.rotate(l.angle + flutter + l.tilt);

    // draw sprite scaled to current size (keep ratio based on base bucket)
    const scale = s / spriteSize;
    const drawW = imgW * scale;
    const drawH = imgH * scale;
    ctx.drawImage(sprite, -drawW/2, -drawH/2, drawW, drawH);

    ctx.restore();
  }

  // update physics
  function update(delta){
    const norm = delta / 16;
    for(let i=0;i<leaves.length;i++){
      const l = leaves[i];
      l.y += l.speed * norm;
      const sway = _sin((l.y*0.018) + l.phase) * (l.sway * 0.6);
      l.x += (sway*0.018) * norm;
      l.angle += l.rotate * norm;
      l.size = l.baseSize * (0.96 + 0.04 * _sin((l.y + l.phase) * 0.03));

      // offscreen / reset
      if(l.y - l.size > H + 60 || l.x < -140 || l.x > W + 140){
        l.x = Math.random() * W;
        l.y = -10 - Math.random() * 160;
        l.baseSize = rand(CONF.sizeRange[0], CONF.sizeRange[1]);
        l.size = l.baseSize;
        l.sizeBucket = bucketSize(l.baseSize);
        l.sway = rand(CONF.swayRange[0], CONF.swayRange[1]);
        l.phase = Math.random()*Math.PI*2;
        l.angle = rand(-0.6, 0.6);
        l.rotate = rand(CONF.rotateSpeed[0], CONF.rotateSpeed[1]) * (Math.random()<0.5?-1:1);
        l.colorIndex = pickIndex(CONF.colors);
        l.colorPair = CONF.colors[l.colorIndex];
        l.speed = rand(CONF.speedY[0], CONF.speedY[1]);
        l.tilt = rand(-0.18, 0.18);
        l.detail = Math.random();
        needsSort = true; // baseSize changed -> may affect draw order
      }
    }
  }

  // render
  function render(now){
    requestAnimationFrame(render);

    const elapsed = now - then;
    if(elapsed < frameInterval) return;
    then = now - (elapsed % frameInterval);

    // avoid heavy work if tab hidden (rAF is throttled but good to be explicit)
    if(document.hidden) return;

    ctx.clearRect(0,0,W,H);
    const t = now;

    if(needsSort){
      leavesSorted = leaves.slice().sort((a,b)=> a.baseSize - b.baseSize);
      needsSort = false;
    }
    const arr = leavesSorted || leaves;

    // draw each leaf (uses cached sprite)
    for(let i=0;i<arr.length;i++){
      drawLeafFromSprite(arr[i], t + i*30);
    }

    update(elapsed);
  }

  // init
  function init(){
    resize();
    then = performance.now();
    requestAnimationFrame(render);
  }

  let rt;
  window.addEventListener('resize', function(){ clearTimeout(rt); rt = setTimeout(resize, 120); });
  window.addEventListener('orientationchange', resize);

  init();

  // expose minimal debug
  window.__leaves = { leaves, resize, makeLeaf };

})();
</script>

</body>

</html>